@page
@model GisanParkGolf_Core.Pages.Account.RegisterModel
@{
    ViewData["Title"] = "회원가입";
}

<div class="container mt-4" style="max-width:600px;">
    <div class="mb-3 text-center">
        <h4 class="fw-bold mb-2">회원가입</h4>
        <p class="text-muted" style="font-size: 0.95rem;">아래 정보를 입력하여 주십시오.</p>
    </div>

    <div class="custom-card">
        <form method="post" id="signupForm">
            <span asp-validation-for="Input.UserId" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">아이디</span>
                <input asp-for="Input.UserId" id="Input_UserId" class="form-control" />
                <button type="button" class="btn btn-outline-secondary" onclick="checkId()">중복확인</button>
                <input type="hidden" id="idChecked" value="false" />
            </div>

            <span asp-validation-for="Input.Password" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">비밀번호</span>
                <input asp-for="Input.Password" class="form-control" type="password" />
            </div>
            
            <span asp-validation-for="Input.PasswordConfirm" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">비밀번호 확인</span>
                <input asp-for="Input.PasswordConfirm" class="form-control" type="password" />
            </div>
            
            <span asp-validation-for="Input.Name" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">이름</span>
                <input asp-for="Input.Name" class="form-control" />
            </div>
            
            <span asp-validation-for="Input.BirthDay" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">생년월일(6자리)</span>
                <input asp-for="Input.BirthDay" class="form-control" maxlength="6" placeholder="YYMMDD" />
            </div>
 
            <span asp-validation-for="Input.Gender" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">성별(1자리)</span>
                <input asp-for="Input.Gender" class="form-control" maxlength="1" type="number" pattern="[1-4]{1}" placeholder="남자(1,3) 여자(2,4)" />
            </div>
            
            <span asp-validation-for="Input.Address" class="text-danger small"></span>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">주소</span>
                <input asp-for="Input.Address" class="form-control" />
                <button type="button" class="btn btn-outline-secondary" onclick="alert('기능 준비중입니다.')">검색</button>
            </div>
            
            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">상세주소</span>
                <input asp-for="Input.Address2" class="form-control" />
            </div>

            <div class="input-group mb-3">
                <span class="input-group-text" style="width:150px;">비고</span>
                <textarea asp-for="Input.Memo" class="form-control" rows="3"></textarea>
            </div>

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary" style="width:160px;" onclick="validateForm()">가입하기</button>
            </div>
        </form>
    </div>
</div>

<!-- 가입 확인 모달 -->
<div class="modal fade" id="saveModal" tabindex="-1" aria-labelledby="saveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="saveModalLabel">저장확인</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                회원가입 하시겠습니까?<br />
                관리자 승인 완료 후 이용 가능합니다.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">아니오</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">예</button>
            </div>
        </div>
    </div>
</div>

<!-- 유효성 검사 결과 모달 -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger fw-bold" id="validationModalLabel">⚠ 입력 확인 필요</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body" id="validationModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>

<!-- ID 중복 검사 결과 모달 -->
<div class="modal fade" id="idCheckModal" tabindex="-1" aria-labelledby="idCheckModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="idCheckModalLabel">아이디 검사 결과</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body" id="idCheckModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ID 중복확인 (stub, 실제 구현은 Ajax 등)
        function checkId() {
            var id = $("#Input_UserId").val();
            if (!id) {
                showIdCheckModal("아이디를 입력하세요.");
                $("#idChecked").val("false");
                return;
            }
            if (id === "admin") {
                showIdCheckModal("admin은 사용할 수 없습니다.");
                $("#idChecked").val("false");
            } else {
                $.ajax({
                    url: "/api/account/checkid",   // 실제 API 경로로 수정
                    type: "GET",
                    data: { userId: id },
                    success: function(response) {
                        if (response.isExist) {
                            showIdCheckModal("이미 사용중인 아이디입니다.");
                            $("#idChecked").val("false");
                        } else {
                            showIdCheckModal("사용 가능한 아이디입니다.");
                            $("#idChecked").val("true");
                        }
                    },
                    error: function() {
                        showIdCheckModal("중복확인 중 오류가 발생했습니다.");
                        $("#idChecked").val("false");
                    }
                });
            }
        }

        function showIdCheckModal(message) {
            $("#idCheckModalBody").text(message);
            var modal = new bootstrap.Modal(document.getElementById('idCheckModal'));
            modal.show();
        }

        // 유효성 검사 후 모달 표시
        function validateForm() {
            // 아이디 중복체크 상태 확인
            if ($("#idChecked").val() !== "true") {
                // 중복확인 안 했거나 실패
                var modal = new bootstrap.Modal(document.getElementById('validationModal'));
                $("#validationModalBody").html("아이디 중복체크를 먼저 확인하여 주십시오.");
                modal.show();
                return;
            }
            var form = $("#signupForm");
            if (form.valid()) {
                var modal = new bootstrap.Modal(document.getElementById('saveModal'));
                modal.show();
            } else {
                // 에러모달에 모든 에러 메시지 표시
                // var errors = [];
                // $(".field-validation-error").each(function() {
                //     errors.push($(this).text());
                // });
                // $("#validationModalBody").html(errors.join("<br>"));
                $("#validationModalBody").html("각 항목의 붉은 글씨를 확인하여 주십시오.");
                var modal = new bootstrap.Modal(document.getElementById('validationModal'));
                modal.show();
            }
        }

        function submitForm() {
            $("#signupForm").submit();
        }

        $("#Input_UserId").on("input", function() {
            $("#idChecked").val("false");
        });
    </script>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <script>
            window.addEventListener('DOMContentLoaded', function () {
                showResultModal(@Json.Serialize(Model.ErrorMessage), "알림");
            });
        </script>
    }
}